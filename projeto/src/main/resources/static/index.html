<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <title>Gest√£o Completa de Usu√°rios</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --secondary: #3b82f6; /* Azul para editar */
            --danger: #ef4444;    /* Vermelho para excluir */
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --border: #e5e7eb;
            --radius: 8px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { margin-top: 0; color: #111827; }
        
        /* Layout Grid Principal */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        /* Cart√µes */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Tabela de Usu√°rios */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td { border-bottom: none; }
        
        /* Bot√µes Pequenos da Tabela */
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
            margin-right: 4px;
        }
        
        .btn-edit { background-color: var(--secondary); }
        .btn-delete { background-color: var(--danger); }

        /* Inputs e Bot√µes Grandes */
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: inherit;
        }

        button.primary-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            width: 100%;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
        }
        
        button.cancel-btn {
            background-color: #9ca3af;
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: none; /* Escondido por padr√£o */
        }

        .form-actions {
            display: flex;
            gap: 10px;
        }

        label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500; }
        
        /* Badges de Status */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="container">
    <header style="margin-bottom:30px; text-align:center;">
        <h1>Painel de Usu√°rios</h1>
        <p style="color:#666;">Gerencie usu√°rios (CRUD), endere√ßos e documentos.</p>
    </header>

    <div class="main-grid">
        
        <div class="card">
            <div class="section-title">
                Lista de Usu√°rios
                <button onclick="loadUsersTable()" class="btn-sm" style="background:#6b7280;">üîÑ Atualizar</button>
            </div>
            
            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th width="50">ID</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th width="60">Idade</th>
                            <th width="140">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align:center">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--primary);">
            <div class="section-title">
                <span id="formTitle">Novo Usu√°rio</span>
            </div>
            
            <form onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="u_id"> <label>Nome Completo</label>
                <input id="u_nome" required placeholder="Ex: Maria Silva">

                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px;">
                    <div>
                        <label>Email</label>
                        <input id="u_email" type="email" placeholder="maria@email.com">
                    </div>
                    <div>
                        <label>Idade</label>
                        <input id="u_idade" type="number" placeholder="0">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" id="btnSave" class="primary-btn">Salvar Usu√°rio</button>
                    <button type="button" id="btnCancel" class="cancel-btn" onclick="cancelEdit()">Cancelar Edi√ß√£o</button>
                </div>
            </form>
            
            <div style="margin-top:10px; font-size:12px; color:#666;">
                Status: <span id="formStatus">Aguardando a√ß√£o...</span>
            </div>
        </div>

        <div class="card">
            <div class="section-title">Adicionar Dados Extras</div>
            <p style="font-size:13px; color:#666; margin-bottom:15px;">Use os formul√°rios abaixo para vincular dados aos usu√°rios criados acima.</p>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <form onsubmit="createEndereco(event)">
                    <label><b>Endere√ßo:</b> Usu√°rio (ID)</label>
                    <input id="e_user_id" type="number" required placeholder="ID do usu√°rio">
                    <label>Rua</label>
                    <input id="e_rua" required placeholder="Nome da rua">
                    <button type="submit" class="btn-sm" style="background:#4b5563; width:100%; padding:10px;">+ Add Endere√ßo</button>
                    <small id="res_end"></small>
                </form>

                <form onsubmit="createDocumento(event)">
                    <label><b>Documento:</b> Usu√°rio (ID)</label>
                    <input id="d_user_id" type="number" required placeholder="ID do usu√°rio">
                    <label>N√∫mero Doc</label>
                    <input id="d_numero" required placeholder="CPF/RG">
                    <button type="submit" class="btn-sm" style="background:#4b5563; width:100%; padding:10px;">+ Add Documento</button>
                    <small id="res_doc"></small>
                </form>
            </div>
        </div>

    </div>
</div>

<script>
    // Don't include a trailing slash here ‚Äî code concatenates paths with a leading slash ("/users").
    // The previous trailing slash produced URLs like https://...//users (double slash) which caused
    // requests to be routed incorrectly and to fail CORS/preflight checks in some environments.
    const BASE_URL = 'https://urban-cod-r47rw7rwwr5jfv9j-8080.app.github.dev';
    let isEditing = false; // Estado para controlar se √© Create ou Edit

    // --- FUN√á√ïES UTILIT√ÅRIAS ---
    async function requestJson(url, method='GET', body=null) {
        const opts = { method, headers: {} };
        if (body) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(body);
        }
        try {
            const res = await fetch(url, opts);
            const text = await res.text();
            try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
            catch (e) { return { ok: res.ok, status: res.status, data: text }; }
        } catch (err) {
            console.error(err);
            return { ok: false, data: "Erro de conex√£o" };
        }
    }

    // --- L√ìGICA DE USU√ÅRIOS (CRUD COMPLETO) ---

    // 1. READ (Ler e montar tabela)
    async function loadUsersTable() {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Atualizando...</td></tr>';
        
        const res = await requestJson(`${BASE_URL}/users`);
        
        if (!res.ok || !Array.isArray(res.data)) {
            tbody.innerHTML = '<tr><td colspan="5" style="color:red; text-align:center">Erro ao carregar usu√°rios ou lista vazia.</td></tr>';
            return;
        }

        tbody.innerHTML = ''; // Limpa
        res.data.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>#${u.id}</td>
                <td><b>${u.nome}</b></td>
                <td>${u.email || '-'}</td>
                <td>${u.idade || '-'}</td>
                <td>
                    <button class="btn-sm btn-edit" onclick='startEdit(${JSON.stringify(u)})'>Editar</button>
                    <button class="btn-sm btn-delete" onclick="deleteUser(${u.id})">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 2. PREPARAR EDI√á√ÉO (Popula o form)
    function startEdit(user) {
        isEditing = true;
        document.getElementById('u_id').value = user.id;
        document.getElementById('u_nome').value = user.nome;
        document.getElementById('u_email').value = user.email || '';
        document.getElementById('u_idade').value = user.idade || '';

        // UI Changes
        document.getElementById('formTitle').textContent = `Editando Usu√°rio #${user.id}`;
        document.getElementById('formTitle').style.color = 'var(--secondary)';
        document.getElementById('btnSave').textContent = 'Atualizar Usu√°rio';
        document.getElementById('btnSave').style.backgroundColor = 'var(--secondary)';
        document.getElementById('btnCancel').style.display = 'block';
        
        document.getElementById('u_nome').focus();
    }

    // 3. CANCELAR EDI√á√ÉO
    function cancelEdit() {
        isEditing = false;
        document.getElementById('u_id').value = '';
        document.getElementById('u_nome').value = '';
        document.getElementById('u_email').value = '';
        document.getElementById('u_idade').value = '';

        // UI Reset
        document.getElementById('formTitle').textContent = 'Novo Usu√°rio';
        document.getElementById('formTitle').style.color = 'var(--text-main)';
        document.getElementById('btnSave').textContent = 'Salvar Usu√°rio';
        document.getElementById('btnSave').style.backgroundColor = 'var(--primary)';
        document.getElementById('btnCancel').style.display = 'none';
    }

    // 4. CREATE ou UPDATE (Submit handler)
    async function handleUserSubmit(ev) {
        ev.preventDefault();
        const id = document.getElementById('u_id').value;
        const nome = document.getElementById('u_nome').value;
        const email = document.getElementById('u_email').value;
        const idade = Number(document.getElementById('u_idade').value);
        const statusEl = document.getElementById('formStatus');

        statusEl.textContent = "Processando...";

        let res;
        if (isEditing) {
            // PUT (Editar)
            res = await requestJson(`${BASE_URL}/users/${id}`, 'PUT', { nome, email, idade });
        } else {
            // POST (Criar)
            res = await requestJson(`${BASE_URL}/users`, 'POST', { nome, email, idade });
        }

        if (res.ok) {
            statusEl.textContent = isEditing ? "Usu√°rio atualizado com sucesso!" : "Usu√°rio criado com sucesso!";
            statusEl.style.color = "green";
            cancelEdit(); // Limpa form e volta ao estado inicial
            loadUsersTable(); // Recarrega lista
        } else {
            statusEl.textContent = "Erro: " + JSON.stringify(res.data);
            statusEl.style.color = "red";
        }
    }

    // 5. DELETE
    async function deleteUser(id) {
        if(!confirm(`Tem certeza que deseja excluir o usu√°rio #${id}?`)) return;
        
        const res = await requestJson(`${BASE_URL}/users/${id}`, 'DELETE');
        if (res.ok) {
            loadUsersTable();
        } else {
            alert("Erro ao excluir: " + JSON.stringify(res.data));
        }
    }

    // --- OUTROS (Endere√ßo/Doc simplificados) ---
    async function createEndereco(ev) {
        ev.preventDefault();
        const usuarioId = Number(document.getElementById('e_user_id').value);
        const rua = document.getElementById('e_rua').value;
        const res = await requestJson(`${BASE_URL}/enderecos`, 'POST', { usuarioId, rua });
        document.getElementById('res_end').textContent = res.ok ? "Endere√ßo salvo!" : "Erro!";
    }

    async function createDocumento(ev) {
        ev.preventDefault();
        const usuarioId = Number(document.getElementById('d_user_id').value);
        const numero = document.getElementById('d_numero').value;
        const res = await requestJson(`${BASE_URL}/documentos`, 'POST', { usuarioId, numero, tipo: 'CPF' });
        document.getElementById('res_doc').textContent = res.ok ? "Doc salvo!" : "Erro!";
    }

    // Inicializa√ß√£o
    window.addEventListener('load', loadUsersTable);
</script>

</body>
</html>